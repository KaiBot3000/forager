<!DOCTYPE html>
<html>
<head>
	
	<meta charset=utf-8 />
		<title>Forager Markers</title>
	<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
	
	<script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
	
	<link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />

	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js'></script>

	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.css' rel='stylesheet' />

	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/MarkerCluster.Default.css' rel='stylesheet' />
	
	<style>
	  body { margin:0; padding:0; }
	  #map { position:absolute; top:0; bottom:0; width:100%; }
	</style>

</head>

<body>

<!-- 	<div id='map' style='width: 75%; height: 75%'> Hay, I'm a map </div> -->

	Other stuff which is not a map

	<div id='detailsDiv'>Plant Details!
	</div>



	<script>

		L.mapbox.accessToken = 'pk.eyJ1IjoicmlzZWxpa2V0aGVtb29uIiwiYSI6IjI4MjczOTIwNzE5MTY1ODI4YmYxZGVlZGZmYjc4NmI0In0.fiUOgIDwB_ByzxT63VWP-g';

		map_location = [37.772849, -122.411227];	
		var map = L.mapbox.map('map', 'riselikethemoon.4b711c00')
			.setView(map_location, 15) 
			//12 is ideal, but this shows markers
			.addLayer(L.mapbox.tileLayer('riselikethemoon.4b711c00'));


		// // using markercluster another way, from http://gis.stackexchange.com/questions/143099/use-mapbox-featurelayer-to-create-marker-clusters
		// var markers = new L.MarkerClusterGroup();
		// var geoJsonFeature = rodents1;
		// var geoJsonLayer = L.geoJson(rodents1);

		// var map = L.mapbox.map('map','mapbox.streets')
		//     .setView([42.35,-71.08],13);

		// markers.addLayer(geoJsonLayer);
		// map.addLayer(markers);   


		// examples.map-h61e8o8e
		// riselikethemoon.4b711c00
		L.mapbox.featureLayer('examples.map-h61e8o8e').on('ready', function(e) {
			// The clusterGroup gets each marker in the group added to it
    		// once loaded, and then is added to the map
    		var markers = new L.MarkerClusterGroup();
    		var markerCollection = {{ marker_collection | safe }};

    		var markerLayer = L.geoJson(markerCollection);

    		// for each marker (layer) in the cluster, add custom popup and change icon
    		markerLayer.eachLayer(function(layer) {
		        var popupContent = '<b>' + layer.feature.properties.title + "</b><br><button type='button' value='plants!' class='detailsBtn'> Details </button> ";

		        // can modify based on properties of feature! Will use to handle undefined features?
		        if (layer.feature.properties.title === 'Olive') {
		        	popupContent ='<div class=detail><b>' + layer.feature.properties.title + '</b><br><button class="detailsBtn">Details</button><br>Surprise! An olive tree!!</div>';

		        	// Changes olive trees to park icon :)
		        	layer.setIcon(L.mapbox.marker.icon({
		        		'marker-symbol': 'park2',
		        		'marker-color': '#00CC00'
		        	}));
		        } else {
		        	layer.setIcon(L.mapbox.marker.icon({
		        		'marker-symbol': 'park',
		        		'marker-color': '#00CC00'
		        	}));
		        };


		    	layer.bindPopup(popupContent, 
		    		className = 'markerPopup'); // can add other options
		    });

    		markers.addLayer(markerLayer);
    		map.addLayer(markers);

    	});

	</script>

	<script src="https://code.jquery.com/jquery.js"> </script>

	<script>
		// javascript zone

		// hidden form submits with id as value
		// event handler catches submit and calls function
		// 		function 
					//prevents default 
					// reformat form info into url
					// $ pass info to server, get details back, feed to function
							// function
									// changes html to formatted details
		// Another way
		// http://stackoverflow.com/questions/17423261/how-to-pass-data-with-marker-in-leaflet-js
		// console.log('in js');
		// function onMarkerClick(evt) {
		//     console.log("You clicked the marker " + evt.target.layer.feature.id);
		// }
		// marker.on('click', onMarkerClick);


		// can I use jquery in the popup?

		var marker;

				// opens as soon as popup pops, passes info, saves as marker
		map.on('popupopen', function(e) {
		  marker = e.popup._source.feature.id;
		  console.log('marker is: ' + marker);
		});

		// Why doesn't this work when the above does?
		// $('#map').on('popupopen', function(e) {
		//   var marker = e.popup._source.feature.id;
		//   console.log('works!');
		//   console.log(marker);
		// });

		// When clicked, use marker
		$('#map').on('click', '.detailsBtn', seeNote);

		// fetches plant object from server using Ajax, display in div with jinja
		function seeNote(evt) {
			console.log('in function, ready to handle: ' + marker);
			//var marker = evt.target.feature.id; // doesn't work

			var plantDetail = '<b> Here is a detail!! </b>';

			//display new info in detail div
			$('#detailsDiv').html(plantDetail);
			console.log('updated div');

		};





		// 	var url = '/plant-detail?' + $('detailsForm').serialize();
		// 	console.log(url);
		// 	// SHOULD pass url to server, then call makeChirps() on resulting info. Doesn't recognize results?
		// 	//$.get(url, makeChirps(results));
		// 	// Using an anonymous function that calls makeChirp works. Hm.
		// 	$.get(url, function (results) {
		// 		display(results);
		// 	});
		// };

		// function display(thing) {
		// 	console.log(thing);
		// };








	</script>

</body>
</html>



<!-- 
{"features": [{
	"id": "832",
	"geometry": {
		"coordinates": [37.72058451344048, -122.40085125402247], 
		"type": "Point"
		}, 
	"properties": {
		"description": null, 
		"marker-size": "small", 
		"marker-symbol": "park2", 
		"title": "Anna apple"
		}, 
	"type": "Feature"}], 
"type": "FeatureCollection"
} -->



<!-- MAPBOX NOTES

use turf to chain together filters, using field of map get bounds. Add event listener for mapzoom, make it get bounds and redraw markers -->




